import pygame
import random
import sys

# --- CONFIGURATION ---
STRIP_IMAGE = "assets/Ace.png"
SYMBOL_COUNT = 6
SYMBOL_WIDTH = 150
SYMBOL_HEIGHT = 100  # 600 / 6
REEL_COUNT = 3
SPIN_SPEED = 40  # Pixels per frame
FPS = 4  # Lower FPS for performance
WINDOW_WIDTH = SYMBOL_WIDTH * REEL_COUNT
WINDOW_HEIGHT = SYMBOL_HEIGHT * 3  # Show 3 symbols per reel
SYMBOL_WEIGHTS = [1] * SYMBOL_COUNT  # Equal chance

# --- INITIALIZATION ---
pygame.init()
screen = pygame.display.set_mode((WINDOW_WIDTH, WINDOW_HEIGHT))
pygame.display.set_caption("Slot Machine - 3 Reels")
clock = pygame.time.Clock()

# --- LOAD & SCALE IMAGE STRIP ---
strip_img = pygame.image.load(STRIP_IMAGE)
strip_img = pygame.transform.scale(strip_img, (SYMBOL_WIDTH, SYMBOL_HEIGHT * SYMBOL_COUNT)).convert()

# --- CUT INDIVIDUAL SYMBOLS ---
symbols = []
for i in range(SYMBOL_COUNT):
    rect = pygame.Rect(0, i * SYMBOL_HEIGHT, SYMBOL_WIDTH, SYMBOL_HEIGHT)
    image = strip_img.subsurface(rect).copy()
    symbols.append(image)

# Pre-calculate reel image height
REEL_IMG_HEIGHT = SYMBOL_HEIGHT * SYMBOL_COUNT

# --- REEL CLASS ---
class Reel:
    def __init__(self, x_pos):
        self.x = x_pos
        self.offset = 0
        self.spinning = False
        self.target_symbol = None
        self.final_offset = 0
        self.spin_distance = 0
        self.spin_speed = SPIN_SPEED
        self.current_distance = 0

    def start_spin(self):
        self.spinning = True
        self.offset = 0
        self.current_distance = 0

        self.target_symbol = random.choices(range(SYMBOL_COUNT), weights=SYMBOL_WEIGHTS)[0]
        full_loops = random.randint(3, 6)
        self.final_offset = self.target_symbol * SYMBOL_HEIGHT
        self.spin_distance = full_loops * SYMBOL_COUNT * SYMBOL_HEIGHT + self.final_offset

    def update(self):
        if self.spinning:
            move = min(self.spin_speed, self.spin_distance - self.current_distance)
            self.current_distance += move
            self.offset = (self.offset + move) % REEL_IMG_HEIGHT

            if self.current_distance >= self.spin_distance:
                self.spinning = False
                self.offset = self.final_offset % REEL_IMG_HEIGHT

    def draw(self, surface):
        center_idx = int(self.offset // SYMBOL_HEIGHT) % SYMBOL_COUNT
        y_offset = -(self.offset % SYMBOL_HEIGHT)

        for i in range(3):  # Draw center and one above/below
            symbol_idx = (center_idx + i - 1) % SYMBOL_COUNT
            y = y_offset + (i * SYMBOL_HEIGHT)
            surface.blit(symbols[symbol_idx], (self.x, y))

# --- SETUP MULTIPLE REELS ---
reels = [Reel(i * SYMBOL_WIDTH) for i in range(REEL_COUNT)]

def start_all_reels():
    for reel in reels:
        reel.start_spin()

def all_stopped():
    return all(not reel.spinning for reel in reels)

# --- MAIN LOOP ---
start_all_reels()
running = True
needs_redraw = True  # Only redraw when needed

while running:
    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False

        elif event.type == pygame.KEYDOWN:
            if event.key == pygame.K_SPACE and all_stopped():
                start_all_reels()
                needs_redraw = True

    # Update reels
    spinning_now = False
    for reel in reels:
        prev_spinning = reel.spinning
        reel.update()
        if reel.spinning:
            spinning_now = True
        if prev_spinning != reel.spinning:
            needs_redraw = True

    # Draw only if spinning or just stopped
    if spinning_now or needs_redraw:
        screen.fill((255, 255, 255))
        for reel in reels:
            reel.draw(screen)
        pygame.display.flip()
        needs_redraw = spinning_now  # Keep redrawing while spinning

    clock.tick(FPS)
    #pygame.display.set_caption(f"Slot Machine - FPS: {clock.get_fps():.2f}")

pygame.quit()




