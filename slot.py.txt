import pygame
import sys
import random
from time import time

# --- CONFIGURATION ---
SCREEN_WIDTH = 1024
SCREEN_HEIGHT = 600
FPS = 30
REEL_COUNT = 3
SYMBOL_HEIGHT = 128
SYMBOL_WIDTH = 128  # original size
TARGET_WIDTH = 328  # scaled width
SPIN_DURATION = 2
REEL_GAP = 20
SPIN_SPEED = 64  # pixels per frame (tweak as needed)

# --- INIT ---
pygame.init()
screen = pygame.display.set_mode((SCREEN_WIDTH, SCREEN_HEIGHT))
pygame.display.set_caption("Slot Machine")
clock = pygame.time.Clock()

# Load reel strip
strip_image = pygame.image.load("assets/reel_strip.png").convert_alpha()
SYMBOL_COUNT = strip_image.get_height() // SYMBOL_HEIGHT

# --- Slice and scale symbols once ---
symbol_surfaces = []
for i in range(SYMBOL_COUNT):
    rect = pygame.Rect(0, i * SYMBOL_HEIGHT, SYMBOL_WIDTH, SYMBOL_HEIGHT)
    symbol = strip_image.subsurface(rect)
    scaled = pygame.transform.scale(symbol, (TARGET_WIDTH, SYMBOL_HEIGHT))
    symbol_surfaces.append(scaled)

# Reel state
offsets = [random.randint(0, SYMBOL_COUNT - 1) * SYMBOL_HEIGHT for _ in range(REEL_COUNT)]
spinning = [False] * REEL_COUNT
start_times = [0] * REEL_COUNT

# Reel X positions
total_width = REEL_COUNT * TARGET_WIDTH + (REEL_COUNT - 1) * REEL_GAP
start_x = (SCREEN_WIDTH - total_width) // 2
reel_positions = [start_x + i * (TARGET_WIDTH + REEL_GAP) for i in range(REEL_COUNT)]

def draw_reels():
    screen.fill((0, 0, 0))
    for i in range(REEL_COUNT):
        x = reel_positions[i]
        offset = offsets[i] % (SYMBOL_COUNT * SYMBOL_HEIGHT)
        start_index = int(offset // SYMBOL_HEIGHT)
        y_shift = offset % SYMBOL_HEIGHT

        # Draw enough symbols to cover screen height
        visible_count = SCREEN_HEIGHT // SYMBOL_HEIGHT + 2
        for j in range(visible_count):
            index = (start_index + j) % SYMBOL_COUNT
            y = (j * SYMBOL_HEIGHT) - y_shift
            screen.blit(symbol_surfaces[index], (x, y))

    pygame.display.flip()

def start_spin():
    for i in range(REEL_COUNT):
        spinning[i] = True
        start_times[i] = time() + i * 0.3

def update_reels():
    now = time()
    for i in range(REEL_COUNT):
        if spinning[i]:
            if now - start_times[i] >= SPIN_DURATION:
                spinning[i] = False
                offsets[i] = ((offsets[i] + SYMBOL_HEIGHT // 2) // SYMBOL_HEIGHT) % SYMBOL_COUNT * SYMBOL_HEIGHT
            else:
                offsets[i] += SPIN_SPEED

# --- MAIN LOOP ---
running = True
while running:
    dt = clock.tick(FPS)
    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False
        elif event.type == pygame.KEYDOWN and event.key == pygame.K_SPACE:
            start_spin()

    update_reels()
    draw_reels()

pygame.quit()
sys.exit()
