import pygame
import sys
import random

pygame.init()

# Screen config
SCREEN_WIDTH = 1024
SCREEN_HEIGHT = 600
screen = pygame.display.set_mode((SCREEN_WIDTH, SCREEN_HEIGHT))
pygame.display.set_caption("Single Reel Slot Machine")

# Symbol config
SYMBOL_WIDTH = 128
SYMBOL_HEIGHT = 128
NUM_SYMBOLS = 6
NUM_ROWS = 3  # visible symbols
FPS = 60

# Load strip and slice symbols
try:
    strip = pygame.image.load("assets/reel_strip.png").convert_alpha()
except Exception as e:
    print(f"Failed to load reel_strip.png: {e}")
    sys.exit()

symbols = []
for i in range(NUM_SYMBOLS):
    rect = pygame.Rect(0, i * SYMBOL_HEIGHT, SYMBOL_WIDTH, SYMBOL_HEIGHT)
    symbols.append(strip.subsurface(rect).copy())

# Reel class (single reel)
class Reel:
    def __init__(self, x):
        self.x = x
        self.offset = random.uniform(0, NUM_SYMBOLS * SYMBOL_HEIGHT)
        self.speed = 0
        self.spinning = False

    def start(self):
        self.speed = random.uniform(40, 60)
        self.spinning = True

    def update(self):
        if self.spinning:
            self.offset = (self.offset + self.speed) % (NUM_SYMBOLS * SYMBOL_HEIGHT)
            self.speed *= 0.95
            if self.speed < 1:
                self.spinning = False
                self.offset = round(self.offset / SYMBOL_HEIGHT) * SYMBOL_HEIGHT

    def draw(self):
        start_index = int(self.offset / SYMBOL_HEIGHT)
        y_offset = - (self.offset % SYMBOL_HEIGHT)

        for i in range(NUM_ROWS + 2):
            index = (start_index + i) % NUM_SYMBOLS
            y = y_offset + i * SYMBOL_HEIGHT
            screen.blit(symbols[index], (self.x, y))

# Center one reel
reel_x = (SCREEN_WIDTH - SYMBOL_WIDTH) // 2
reel = Reel(reel_x)

# Game loop
clock = pygame.time.Clock()
running = True
spinning = False

while running:
    screen.fill((0, 0, 0))

    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False
        elif event.type == pygame.KEYDOWN and event.key == pygame.K_SPACE:
            if not spinning:
                reel.start()
                spinning = True

    if reel.spinning:
        spinning = True
    else:
        spinning = False

    reel.update()
    reel.draw()

    pygame.display.flip()
    clock.tick(FPS)

pygame.quit()
