import pygame
import sys
import random

pygame.init()

# Config
SCREEN_WIDTH = 1024
SCREEN_HEIGHT = 600
SYMBOL_WIDTH = 128
SYMBOL_HEIGHT = 128
NUM_SYMBOLS = 6
NUM_ROWS = 3
REEL_COUNT = 3
FPS = 60

# Display
screen = pygame.display.set_mode((SCREEN_WIDTH, SCREEN_HEIGHT))
pygame.display.set_caption("Slot Machine")

# Load strip
try:
    reel_strip = pygame.image.load("asset/reel_strip.png").convert_alpha()
except pygame.error as e:
    print(f"Error loading image: {e}")
    sys.exit()

strip_height = reel_strip.get_height()

# Reel class
class Reel:
    def __init__(self, x):
        self.x = x
        self.offset = random.randint(0, strip_height - 1)
        self.speed = 0
        self.spinning = False

    def start_spin(self):
        self.spinning = True
        self.speed = random.randint(40, 60)

    def update(self):
        if self.spinning:
            self.offset = (self.offset + self.speed) % strip_height
            self.speed *= 0.95  # friction
            if self.speed < 1:
                self.spinning = False
                self.offset = round(self.offset / SYMBOL_HEIGHT) * SYMBOL_HEIGHT

    def draw(self):
        base_y = - (self.offset % SYMBOL_HEIGHT)
        symbol_index = int(self.offset / SYMBOL_HEIGHT)

        for i in range(NUM_ROWS + 2):  # draw one extra to cover gaps
            idx = (symbol_index + i) % NUM_SYMBOLS
            symbol_rect = pygame.Rect(0, idx * SYMBOL_HEIGHT, SYMBOL_WIDTH, SYMBOL_HEIGHT)
            symbol_img = reel_strip.subsurface(symbol_rect)
            y = base_y + i * SYMBOL_HEIGHT
            screen.blit(symbol_img, (self.x, y))


# Layout
total_reel_width = REEL_COUNT * SYMBOL_WIDTH + (REEL_COUNT - 1) * 40
start_x = (SCREEN_WIDTH - total_reel_width) // 2

reels = [Reel(start_x + i * (SYMBOL_WIDTH + 40)) for i in range(REEL_COUNT)]

# Main loop
clock = pygame.time.Clock()
running = True
spinning = False

while running:
    screen.fill((0, 0, 0))

    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False
        elif event.type == pygame.KEYDOWN and event.key == pygame.K_SPACE:
            if not spinning:
                for reel in reels:
                    reel.start_spin()
                spinning = True

    spinning = any(reel.spinning for reel in reels)

    for reel in reels:
        reel.update()
        reel.draw()

    pygame.display.flip()
    clock.tick(FPS)

pygame.quit()
sys.exit()
