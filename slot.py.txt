import pygame
import sys
import random

pygame.init()

# Constants
SCREEN_WIDTH = 1024
SCREEN_HEIGHT = 600
SYMBOL_WIDTH = 128
SYMBOL_HEIGHT = 128
NUM_SYMBOLS = 6
NUM_ROWS = 3
REEL_COUNT = 3
FPS = 60

# Display
screen = pygame.display.set_mode((SCREEN_WIDTH, SCREEN_HEIGHT))
pygame.display.set_caption("Slot Machine")

# Load strip and pre-slice
try:
    strip = pygame.image.load("assets/reel_strip.png").convert_alpha()
except Exception as e:
    print(f"Failed to load reel_strip.png: {e}")
    sys.exit()

# Pre-slice symbols
symbols = []
for i in range(NUM_SYMBOLS):
    rect = pygame.Rect(0, i * SYMBOL_HEIGHT, SYMBOL_WIDTH, SYMBOL_HEIGHT)
    symbols.append(strip.subsurface(rect).copy())

# Reel class
class Reel:
    def __init__(self, x):
        self.x = x
        self.offset = random.uniform(0, NUM_SYMBOLS * SYMBOL_HEIGHT)
        self.speed = 0
        self.spinning = False

    def start(self):
        self.speed = random.uniform(40, 60)
        self.spinning = True

    def update(self):
        if self.spinning:
            self.offset = (self.offset + self.speed) % (NUM_SYMBOLS * SYMBOL_HEIGHT)
            self.speed *= 0.95
            if self.speed < 1:
                self.spinning = False
                self.offset = round(self.offset / SYMBOL_HEIGHT) * SYMBOL_HEIGHT

    def draw(self):
        start_index = int(self.offset / SYMBOL_HEIGHT)
        y_offset = - (self.offset % SYMBOL_HEIGHT)

        for i in range(NUM_ROWS + 2):
            index = (start_index + i) % NUM_SYMBOLS
            y = y_offset + i * SYMBOL_HEIGHT
            screen.blit(symbols[index], (self.x, y))

# Center reels on screen
spacing = 40
total_width = REEL_COUNT * SYMBOL_WIDTH + (REEL_COUNT - 1) * spacing
start_x = (SCREEN_WIDTH - total_width) // 2
reels = [Reel(start_x + i * (SYMBOL_WIDTH + spacing)) for i in range(REEL_COUNT)]

# Game loop
clock = pygame.time.Clock()
running = True
spinning = False

while running:
    screen.fill((0, 0, 0))

    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False
        elif event.type == pygame.KEYDOWN and event.key == pygame.K_SPACE:
            if not spinning:
                for reel in reels:
                    reel.start()
                spinning = True

    spinning = any(reel.spinning for reel in reels)

    for reel in reels:
        reel.update()
        reel.draw()

    pygame.display.flip()
    clock.tick(FPS)

pygame.quit()
