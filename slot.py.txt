import pygame
import sys
import random

# Initialize
pygame.init()

# Constants
SCREEN_WIDTH = 800
SCREEN_HEIGHT = 400
SYMBOL_HEIGHT = 128
SYMBOL_WIDTH = 128
NUM_SYMBOLS = 6
NUM_ROWS = 3
REEL_COUNT = 3
FPS = 60

# Setup screen
screen = pygame.display.set_mode((SCREEN_WIDTH, SCREEN_HEIGHT))
pygame.display.set_caption("Slot Machine")

# Load reel strip
try:
    reel_strip = pygame.image.load("asset/reel_strip.png").convert_alpha()
except pygame.error as e:
    print(f"Image load error: {e}")
    sys.exit()

strip_height = reel_strip.get_height()

# Reel class
class Reel:
    def __init__(self, x):
        self.x = x
        self.offset = random.randint(0, strip_height)
        self.speed = 0
        self.spinning = False

    def start_spin(self):
        self.spinning = True
        self.speed = random.randint(40, 60)

    def update(self):
        if self.spinning:
            self.offset = (self.offset + self.speed) % strip_height
            self.speed *= 0.95
            if self.speed < 1:
                self.spinning = False
                self.offset = round(self.offset / SYMBOL_HEIGHT) * SYMBOL_HEIGHT

    def draw(self):
        for i in range(NUM_ROWS + 1):
            y_index = (self.offset + i * SYMBOL_HEIGHT) % strip_height
            rect = pygame.Rect(0, y_index, SYMBOL_WIDTH, SYMBOL_HEIGHT)
            image = reel_strip.subsurface(rect)
            draw_y = i * SYMBOL_HEIGHT - (self.offset % SYMBOL_HEIGHT)
            screen.blit(image, (self.x, draw_y))

# Init reels
reels = []
for i in range(REEL_COUNT):
    x = 100 + i * (SYMBOL_WIDTH + 40)
    reels.append(Reel(x))

# Main loop
clock = pygame.time.Clock()
running = True
spinning = False

while running:
    screen.fill((0, 0, 0))

    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False

        elif event.type == pygame.KEYDOWN and event.key == pygame.K_SPACE:
            if not spinning:
                for reel in reels:
                    reel.start_spin()
                spinning = True

    spinning = any(reel.spinning for reel in reels)

    for reel in reels:
        reel.update()
        reel.draw()

    pygame.display.flip()
    clock.tick(FPS)

pygame.quit()
sys.exit()
