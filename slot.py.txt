import pygame
import random
import sys

# Constants
SCREEN_WIDTH = 1024
SCREEN_HEIGHT = 600
REEL_WIDTH = 128
SYMBOL_HEIGHT = 128
NUM_ROWS = 3
NUM_REELS = 3
REEL_SPACING = 40  # spacing between reels

# Calculate positions
REEL_HEIGHT = SYMBOL_HEIGHT * NUM_ROWS
MARGIN_TOP = (SCREEN_HEIGHT - REEL_HEIGHT) // 2
START_X = (SCREEN_WIDTH - (NUM_REELS * REEL_WIDTH + (NUM_REELS - 1) * REEL_SPACING)) // 2

# Pygame init
pygame.init()
screen = pygame.display.set_mode((SCREEN_WIDTH, SCREEN_HEIGHT))
pygame.display.set_caption("Slot Machine")
clock = pygame.time.Clock()

# Load reel strip
reel_strip = pygame.image.load("assets/reel_strip.png").convert_alpha()
strip_height = reel_strip.get_height()
num_symbols = strip_height // SYMBOL_HEIGHT

# Create reels with random starting offsets
reels = []
for _ in range(NUM_REELS):
    offset = random.randint(0, strip_height - SYMBOL_HEIGHT)
    reels.append(offset)

def draw_reel(reel_x, offset):
    for i in range(NUM_ROWS + 1):  # draw one extra for smooth scrolling
        symbol_y = (offset + i * SYMBOL_HEIGHT) % strip_height
        symbol_rect = pygame.Rect(0, symbol_y, REEL_WIDTH, SYMBOL_HEIGHT)
        screen.blit(reel_strip, (reel_x, MARGIN_TOP + i * SYMBOL_HEIGHT - (offset % SYMBOL_HEIGHT)), symbol_rect)

def spin_reels():
    speeds = [random.randint(20, 30) for _ in range(NUM_REELS)]
    durations = [random.randint(60, 90) for _ in range(NUM_REELS)]
    frames = 0

    while any(duration > 0 for duration in durations):
        screen.fill((0, 0, 0))

        for i in range(NUM_REELS):
            if durations[i] > 0:
                reels[i] = (reels[i] + speeds[i]) % strip_height
                durations[i] -= 1
            draw_reel(START_X + i * (REEL_WIDTH + REEL_SPACING), reels[i])

        pygame.display.flip()
        clock.tick(30)
        frames += 1

# Game loop
running = True
while running:
    screen.fill((0, 0, 0))

    # Draw reels
    for i in range(NUM_REELS):
        draw_reel(START_X + i * (REEL_WIDTH + REEL_SPACING), reels[i])

    pygame.display.flip()
    clock.tick(30)

    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False

        if event.type == pygame.KEYDOWN:
            if event.key == pygame.K_SPACE:
                spin_reels()

pygame.quit()
sys.exit()
